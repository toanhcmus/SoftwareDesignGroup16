<!DOCTYPE html>
<html>

<head>
    <title>HappyGroup</title>
    <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <style>
        .card {
            margin-bottom: 20px;
        }

        .filter-section {
            margin-bottom: 30px;
        }

        .card-img-top {
            height: 200px;
            object-fit: cover;
        }
        .row-chose{
            display: flex;
            margin: 18px;
        }
        .choose-link{
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <div class="container my-4">
        <h1 class="text-center mb-4">HappyGroup</h1>

        <div class="filter-section">
            <div class="row mb-3">
                <div class="card  " style="width: 120px;background-color: rgb(49, 222, 124);" onclick="saveStates()">
                    <div class=" text-center " > Save State  </div>
                    <dotlottie-player src="https://lottie.host/1fa0fb22-fe2f-4246-8450-23f370b0b13b/J87Mk0t8c6.json"
                        background="transparent" speed="1" style="width: 100px; height: 100px; " direction="1"
                        playMode="normal" loop  autoplay></dotlottie-player>
                </div>
                <div class="col-md-6">
                    <form method="GET">
                        <div class="input-group">
                            <input type="text" name="keyword" class="form-control" placeholder="Tìm kiếm...">
                            <button class="btn btn-primary" type="submit">Tìm kiếm</button>
                        </div>
                    </form>
                    <button type="button" class="btn btn-success btn-lg" onclick="saveStates()">Nguyễn Song Toàn chạy
                        DL nhanh lên</button>
                </div>

                <div class="col-md-4" >
                    <div class="btn-group">
                        <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                          Mức độ ưu tiên
                        </button>
                        <div class="dropdown-menu">
                          <div class="dropdown-item" id="container-chose-link">
                            <button id="reset-chose-link" onclick="resetLinks()">Thiết lập lại</button>
                           
                        </div>
                        </div>
                      </div>
                    
                </div>
            </div>
        </div>

        <%if (isSearched){ %>

            <% if (novels.length>0) { %>
                <div id="container-list-novels">
                    <h2 class="text-center mb-4">Danh sách truyện</h2>
                    <div class="row row-cols-1 row-cols-md-4 g-4">
                        <% for(var i=0; i<novels.length; i++) {%>
                            <div class="col">
                                <div class="card">
                                    <img src="<%= novels[i].cover || novels[i].image %>" class="card-img-top"
                                        alt="Card Image">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <%= novels[i].title %>
                                        </h5>
                                        <p class="card-text">
                                            <%= novels[i].author %>
                                        </p>
                                        <p class="card-text">
                                            <%= novels[i].origin %>
                                        </p>
                                        <p class="card-text"> <a
                                                href="/name=<%= encodeURIComponent(novels[i].title) %>/src=<%= novels[i].origin %>/page=1">Chi
                                                tiết</a></p>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                    </div>

                    <% } else { %>
                        <h2>Từ khóa tìm kiếm không hợp lệ</h2>
                        <%} %>


                            <%} else { %>
                                <h2>Nhập từ khóa để tìm kiếm</h2>
                                <% } %>





                </div>

                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
                    integrity="sha384-ENjdO4Dr2bkBIFxQpIdKSsYG1g3PHPWlDxLgmNkwlghG56Yd7whQYGHIgKmZoZnl"
                    crossorigin="anonymous"></script>
                <script>
                    var mLinksGlobal=<%- JSON.stringify(srcList) %>;
                    var mLink =<%- JSON.stringify(srcList) %>;
                    
                    function resetLinks() {
                        console.log("abc");
                        mLink =mLinksGlobal;
                        var selects = document.querySelectorAll(".choose-link");
                        for (var i = 0; i < selects.length; i++) {
                            var select = selects[i];
                            select.innerHTML = ''
                            var newOption = document.createElement("option");
                            newOption.value = "";
                            newOption.text = "Chọn truyện";
                            select.add(newOption);
                            mLink.forEach(function (option) {
                                var newOption = document.createElement("option");
                                newOption.value = option;
                                newOption.text = option;
                                select.add(newOption);
                            });
                            select.disabled = false

                        }
                    };

                    function updateSelectOptions(selectedOptionId) {
                        // Lấy giá trị đã chọn từ select option
                        console.log("-------------------")
                        var selectedOptionElement = document.getElementById(selectedOptionId);

                        selectedOptionElement.disabled = true

                        // Loại bỏ truyện đã chọn khỏi mảng truyen
                        mLink = mLink.filter(function (option) {
                            return option !== selectedOptionElement.value;
                        });

                        // Cập nhật lại danh sách tùy chọn cho các ô chọn khác
                        var selects = document.querySelectorAll(".choose-link");

                        for (var i = 0; i < selects.length; i++) {
                            var select = selects[i];
                            if (select.id != selectedOptionId && select.value === "") {
                                console.log("a " + select.id)
                                select.innerHTML = ''
                                if (mLink.length == 1) {
                                    select.disabled = true
                                }
                                if (mLink.length > 1) {
                                    var newOption = document.createElement("option");
                                    newOption.value = "";
                                    newOption.text = "Chọn truyện";
                                    select.add(newOption);
                                }
                                mLink.forEach(function (option) {
                                    var newOption = document.createElement("option");
                                    newOption.value = option;
                                    newOption.text = option;
                                    select.add(newOption);
                                });
                            }

                        }
                    }
                    
                    async function saveStates() {
                        console.log('aaaaaaaaaa')
                        try {
                            const response = await fetch('/saveStates', {
                                method: 'GET'
                            });
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            const data = await response.json();
                            console.log('Success:', data);
                            if (data.redirect) {
                                window.location.href = data.redirect;
                            }
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    }
                    
                    function insertChosenLinksPriority(){
                        const containerChooseLinks=document.getElementById('container-chose-link');
                        const newDiv = document.createElement('div');
                        var contentLinks="";
                        var contentOptions = "<option value=\"\" selected hidden>Chọn truyện</option>";
                        for(let i=0;i<mLinksGlobal.length;i++){
                                 contentOptions+= `<option value="${mLinksGlobal[i]}">${mLinksGlobal[i]}
                                                   </option>`
                        }
                        for(let i=0;i<mLinksGlobal.length;i++){
                            contentLinks+= `
                            <div class="row-chose">
                                    <div>${i+1}</div>
                                    <select id="select-option-${i+1}" class="choose-link"
                                        onchange="updateSelectOptions('select-option-${i+1}')">
                                        ${contentOptions}
                                    </select>
                            </div>
                            `
                        }
                        newDiv.innerHTML=contentLinks;
                        containerChooseLinks.appendChild(newDiv);
                        
                    }
                    insertChosenLinksPriority();
                </script>

</body>

</html>